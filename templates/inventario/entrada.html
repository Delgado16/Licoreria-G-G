{% extends "base.html" %}

{% block title %}Entrada de Inventario - Licoreria G&G{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-box-arrow-in-down"></i> Entrada de Inventario
        </h1>
        <div>
            <button class="btn btn-outline-secondary" onclick="limpiarFormulario()">
                <i class="bi bi-arrow-clockwise"></i> Limpiar
            </button>
            <a href="{{ url_for('inventario') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver al Inventario
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Panel de Información General -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información del Movimiento</h5>
                </div>
                <div class="card-body">
                    <form id="formEntrada">
                        <div class="mb-3">
                            <label for="tipo_movimiento" class="form-label">Tipo de Movimiento *</label>
                            <select id="tipo_movimiento" class="form-select" required>
                                <option value="">Seleccionar tipo...</option>
                                {% for tipo in tipos_movimiento %}
                                <option value="{{ tipo.ID_TipoMovimiento }}" 
                                        data-adicion="{{ tipo.Adicion }}">
                                    {{ tipo.Descripcion }} ({{ tipo.Letra }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="bodega" class="form-label">Bodega Destino *</label>
                            <select id="bodega" class="form-select" required>
                                <option value="">Seleccionar bodega...</option>
                                {% for bodega in bodegas %}
                                <option value="{{ bodega.ID_Bodega }}">{{ bodega.Nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="proveedor" class="form-label">Proveedor *</label>
                            <div class="d-flex gap-2">
                                <select id="proveedor" class="form-select" required>
                                    <option value="">Seleccionar proveedor...</option>
                                    {% for proveedor in proveedores %}
                                    <option value="{{ proveedor.ID_Proveedor }}" 
                                            {% if proveedor_filtro == proveedor.ID_Proveedor %}selected{% endif %}>
                                        {{ proveedor.Nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-info" onclick="aplicarFiltroProveedor()" 
                                        title="Ver productos comprados anteriormente">
                                    <i class="bi bi-funnel"></i>
                                </button>
                                {% if proveedor_filtro %}
                                <button type="button" class="btn btn-outline-danger" onclick="quitarFiltroProveedor()">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% if proveedor_filtro %}
                            <small class="text-muted mt-1 d-block">
                                <i class="bi bi-info-circle"></i> 
                                {% if proveedor_actual_estado != 'activo' %}
                                <span class="text-warning">Proveedor inactivo - </span>
                                {% endif %}
                                Mostrando todos los productos. Los comprados anteriormente aparecen primero.
                            </small>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="n_factura" class="form-label">N° Factura/Documento</label>
                                    <input type="text" id="n_factura" class="form-control" 
                                           placeholder="Dejar en blanco para generar automático">
                                    <small class="text-muted">Dejar vacío para generar referencia interna CMP-000001</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fecha_movimiento" class="form-label">Fecha</label>
                                    <input type="date" id="fecha_movimiento" class="form-control" 
                                           value="{{ now().strftime('%Y-%m-%d') }}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacion" class="form-label">Observaciones</label>
                            <textarea id="observacion" class="form-control" rows="3" 
                                      placeholder="Descripción del movimiento..."></textarea>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Resumen del Movimiento -->
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Resumen</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 id="totalProductos" class="text-primary">0</h4>
                            <small class="text-muted">Productos</small>
                        </div>
                        <div class="col-6">
                            <h4 id="totalCantidad" class="text-success">0</h4>
                            <small class="text-muted">Unidades</small>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Total Entrada:</strong>
                        <span id="totalMovimiento" class="h5 text-success">C$0.00</span>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button id="btnGuardar" class="btn btn-success btn-lg" onclick="guardarEntrada()" disabled>
                            <i class="bi bi-check-circle"></i> Registrar Entrada
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Productos -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Gestión de Productos</h5>
                        {% if proveedor_filtro %}
                        <small class="d-block mt-1">
                            <i class="bi bi-lightning"></i> 
                            Filtro activo: {{ productos|length }} productos disponibles
                            {% if proveedor_actual_nombre %}
                            - {{ proveedor_actual_nombre }}
                            {% endif %}
                        </small>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="input-group" style="width: 250px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchProducto" class="form-control" 
                                   placeholder="Buscar producto...">
                        </div>
                        <button class="btn btn-outline-light btn-sm" onclick="mostrarTodosProductos()">
                            <i class="bi bi-list"></i> Mostrar todos
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Productos Agregados -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-list-check"></i> Productos en la Entrada
                            <span class="badge bg-primary ms-2" id="contadorProductos">0</span>
                        </h6>
                        <div id="productosAgregados" class="table-responsive" style="max-height: 300px;">
                            <table class="table table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Producto</th>
                                        <th width="100">Cantidad</th>
                                        <th width="120">Costo Unit.</th>
                                        <th width="120">Total</th>
                                        <th width="80">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductosBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                            No hay productos agregados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Lista de Productos Disponibles -->
                    <h6 class="border-bottom pb-2">
                        <i class="bi bi-box"></i> Catálogo de Productos
                        <span class="badge bg-light text-dark">{{ productos|length }} productos</span>
                        {% if proveedor_filtro %}
                        <span class="badge bg-info ms-2">
                            <i class="bi bi-check-circle"></i> 
                            {{ productos|selectattr('Comprado_Anteriormente', 'equalto', 1)|list|length }} productos comprados antes
                        </span>
                        {% endif %}
                    </h6>
                    
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Existencia</th>
                                    <th>Costo Prom.</th>
                                    <th width="100">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="productosTableBody">
                                {% for producto in productos %}
                                <tr class="producto-row" 
                                    data-nombre="{{ producto.Descripcion|lower }}" 
                                    data-categoria="{{ producto.Categoria|lower if producto.Categoria else '' }}"
                                    {% if proveedor_filtro and producto.Comprado_Anteriormente %}
                                    style="background-color: #e8f5e9;"
                                    {% endif %}>
                                    <td>
                                        <strong>{{ producto.Descripcion }}</strong>
                                        <br>
                                        <small class="text-muted">{{ producto.Abreviatura }}</small>
                                        {% if proveedor_filtro and producto.Comprado_Anteriormente %}
                                        <br>
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> Comprado antes
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ producto.Categoria or 'Sin categoría' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge {% if producto.Existencias_Totales <= producto.Stock_minimo %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ "%.0f"|format(producto.Existencias_Totales) }} {{ producto.Abreviatura }}
                                        </span>
                                        {% if producto.Existencias_Totales <= producto.Stock_minimo %}
                                        <br><small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Mín: {{ producto.Stock_minimo }}</small>
                                        {% endif %}
                                    </td>
                                    <td>C${{ "%.2f"|format(producto.Costo_Promedio or 0) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="mostrarModalProducto({{ producto.ID_Producto }}, '{{ producto.Descripcion }}', {{ producto.Existencias_Totales }}, '{{ producto.Abreviatura }}', {{ producto.Costo_Promedio or 0 }})">
                                            <i class="bi bi-plus-lg"></i> Agregar
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="bi bi-database-slash display-4 d-block mb-2"></i>
                                        No hay productos disponibles
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalProductoTitulo">Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formProducto">
                    <input type="hidden" id="modalProductoId">
                    <div class="mb-3">
                        <label class="form-label">Producto</label>
                        <p class="form-control-plaintext" id="modalProductoNombre"></p>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCantidad" class="form-label">Cantidad *</label>
                                <input type="number" id="modalCantidad" class="form-control" 
                                       min="1" step="1" required>
                                <small class="text-muted">Cantidad entera</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCosto" class="form-label">Costo Unitario (C$) *</label>
                                <input type="number" id="modalCosto" class="form-control" 
                                       min="0.01" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <p class="h5 text-success" id="modalTotal">C$0.00</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-success" onclick="agregarDesdeModal()">
                    <i class="bi bi-plus-circle"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let productosEntrada = [];
let modalProducto = null;

document.addEventListener('DOMContentLoaded', function() {
    modalProducto = new bootstrap.Modal(document.getElementById('modalProducto'));
    
    // Calcular total en tiempo real
    document.getElementById('modalCantidad').addEventListener('input', calcularTotalModal);
    document.getElementById('modalCosto').addEventListener('input', calcularTotalModal);
    
    // Búsqueda avanzada
    document.getElementById('searchProducto').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.producto-row');
        
        rows.forEach(row => {
            const nombre = row.getAttribute('data-nombre');
            const categoria = row.getAttribute('data-categoria');
            const match = nombre.includes(searchTerm) || categoria.includes(searchTerm);
            row.style.display = match ? '' : 'none';
        });
    });
    
    // Validación en tiempo real de los campos requeridos
    const camposRequeridos = ['tipo_movimiento', 'bodega', 'proveedor'];
    camposRequeridos.forEach(id => {
        document.getElementById(id).addEventListener('change', validarCamposRequeridos);
    });
});

// FUNCIÓN PARA VALIDAR CAMPOS REQUERIDOS
function validarCamposRequeridos() {
    const tipoMovimiento = document.getElementById('tipo_movimiento').value;
    const bodega = document.getElementById('bodega').value;
    const proveedor = document.getElementById('proveedor').value;
    
    return tipoMovimiento && bodega && proveedor;
}

// FUNCIÓN PARA APLICAR FILTRO DE PROVEEDOR (sin recargar página)
function aplicarFiltroProveedor() {
    const proveedorId = document.getElementById('proveedor').value;
    if (!proveedorId) {
        mostrarToast('Selecciona un proveedor primero', 'warning');
        return;
    }
    
    // Actualizar URL sin recargar la página
    const url = new URL(window.location.href);
    url.searchParams.set('proveedor_filtro', proveedorId);
    window.history.pushState({}, '', url);
    
    // Recargar solo los productos vía AJAX
    cargarProductosFiltrados(proveedorId);
    mostrarToast('Filtro aplicado: productos comprados anteriormente aparecen primero', 'info');
}

// FUNCIÓN PARA CARGAR PRODUCTOS FILTRADOS VÍA AJAX
async function cargarProductosFiltrados(proveedorId) {
    try {
        const response = await fetch(`/api/productos_por_proveedor/${proveedorId}`);
        const productos = await response.json();
        
        // Actualizar la tabla de productos
        actualizarTablaProductos(productos);
        
        // Mostrar información del proveedor
        const proveedorNombre = document.querySelector(`#proveedor option[value="${proveedorId}"]`).textContent;
        mostrarToast(`Mostrando productos. Los comprados a ${proveedorNombre} aparecen primero`, 'info');
    } catch (error) {
        console.error('Error al cargar productos filtrados:', error);
    }
}

// FUNCIÓN PARA ACTUALIZAR TABLA DE PRODUCTOS
function actualizarTablaProductos(productos) {
    const tbody = document.getElementById('productosTableBody');
    
    if (productos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-database-slash display-4 d-block mb-2"></i>
                    No hay productos disponibles
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    productos.forEach(producto => {
        html += `
            <tr class="producto-row" 
                data-nombre="${producto.Descripcion.toLowerCase()}" 
                data-categoria="${(producto.Categoria || '').toLowerCase()}"
                ${producto.Comprado_Anteriormente ? 'style="background-color: #e8f5e9;"' : ''}>
                <td>
                    <strong>${producto.Descripcion}</strong>
                    <br>
                    <small class="text-muted">${producto.Abreviatura}</small>
                    ${producto.Comprado_Anteriormente ? 
                    '<br><small class="text-success"><i class="bi bi-check-circle"></i> Comprado antes</small>' : ''}
                </td>
                <td>
                    <span class="badge bg-light text-dark">${producto.Categoria || 'Sin categoría'}</span>
                </td>
                <td>
                    <span class="badge ${producto.Existencias_Totales <= producto.Stock_minimo ? 'bg-warning' : 'bg-secondary'}">
                        ${producto.Existencias_Totales} ${producto.Abreviatura}
                    </span>
                    ${producto.Existencias_Totales <= producto.Stock_minimo ? 
                    `<br><small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Mín: ${producto.Stock_minimo}</small>` : ''}
                </td>
                <td>C$${parseFloat(producto.Costo_Promedio || 0).toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-success" 
                            onclick="mostrarModalProducto(${producto.ID_Producto}, '${producto.Descripcion.replace(/'/g, "\\'")}', ${producto.Existencias_Totales}, '${producto.Abreviatura}', ${producto.Costo_Promedio || 0})">
                        <i class="bi bi-plus-lg"></i> Agregar
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// FUNCIÓN PARA QUITAR FILTRO DE PROVEEDOR
function quitarFiltroProveedor() {
    // Actualizar URL sin recargar la página
    const url = new URL(window.location.href);
    url.searchParams.delete('proveedor_filtro');
    window.history.pushState({}, '', url);
    
    // Recargar la página para ver todos los productos
    location.reload();
}

// ===== FUNCIONES RESTANTES SE MANTIENEN IGUAL =====
// (mostrarModalProducto, calcularTotalModal, agregarDesdeModal,
//  actualizarListaProductos, limpiarFormulario, guardarEntrada, etc.)

function mostrarTodosProductos() {
    document.getElementById('searchProducto').value = '';
    const rows = document.querySelectorAll('.producto-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    mostrarToast('Mostrando todos los productos', 'info');
}

function mostrarModalProducto(id, nombre, stockActual, unidad, costoPromedio) {
    document.getElementById('modalProductoId').value = id;
    document.getElementById('modalProductoNombre').textContent = `${nombre} (${unidad})`;
    document.getElementById('modalCantidad').value = '';
    document.getElementById('modalCosto').value = costoPromedio.toFixed(2) || '';
    document.getElementById('modalTotal').textContent = 'C$0.00';
    
    modalProducto.show();
}

function calcularTotalModal() {
    const cantidad = parseInt(document.getElementById('modalCantidad').value) || 0;
    const costo = parseFloat(document.getElementById('modalCosto').value) || 0;
    const total = cantidad * costo;
    document.getElementById('modalTotal').textContent = `C$${total.toFixed(2)}`;
}

function agregarDesdeModal() {
    const id = document.getElementById('modalProductoId').value;
    const nombre = document.getElementById('modalProductoNombre').textContent.split(' (')[0];
    const cantidad = parseInt(document.getElementById('modalCantidad').value);
    const costo = parseFloat(document.getElementById('modalCosto').value);
    const unidad = document.getElementById('modalProductoNombre').textContent.match(/\(([^)]+)\)/)[1];
    
    if (!cantidad || cantidad <= 0) {
        mostrarToast('Ingresa una cantidad válida (número entero)', 'warning');
        return;
    }
    
    if (!costo || costo <= 0) {
        mostrarToast('Ingresa un costo válido', 'warning');
        return;
    }
    
    // Verificar si el producto ya existe
    const indexExistente = productosEntrada.findIndex(p => p.producto_id == id);
    const costoTotal = cantidad * costo;
    
    if (indexExistente !== -1) {
        if (!confirm('Este producto ya está en la lista. ¿Desea actualizar la cantidad y costo?')) {
            return;
        }
        productosEntrada[indexExistente].cantidad = cantidad;
        productosEntrada[indexExistente].costo = costo;
        productosEntrada[indexExistente].costo_total = costoTotal;
    } else {
        productosEntrada.push({
            producto_id: parseInt(id),
            nombre: nombre,
            cantidad: cantidad,
            costo: costo,
            costo_total: costoTotal,
            unidad: unidad
        });
    }
    
    modalProducto.hide();
    actualizarListaProductos();
    mostrarToast('Producto agregado', 'success');
}

function actualizarListaProductos() {
    const tbody = document.getElementById('tablaProductosBody');
    const contador = document.getElementById('contadorProductos');
    const btnGuardar = document.getElementById('btnGuardar');
    const totalProductos = document.getElementById('totalProductos');
    const totalCantidad = document.getElementById('totalCantidad');
    const totalMovimiento = document.getElementById('totalMovimiento');
    
    if (productosEntrada.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-4 d-block mb-2"></i>
                    No hay productos agregados
                </td>
            </tr>
        `;
        btnGuardar.disabled = true;
        totalProductos.textContent = '0';
        totalCantidad.textContent = '0';
        totalMovimiento.textContent = 'C$0.00';
        contador.textContent = '0';
        return;
    }
    
    let html = '';
    let totalUnidades = 0;
    let totalGeneral = 0;
    
    productosEntrada.forEach((item, index) => {
        totalUnidades += item.cantidad;
        totalGeneral += item.costo_total;
        
        html += `
            <tr>
                <td>
                    <strong>${item.nombre}</strong>
                    <br><small class="text-muted">${item.unidad}</small>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${item.cantidad}" min="1" step="1"
                           onchange="actualizarCantidad(${index}, this.value)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${item.costo.toFixed(2)}" min="0.01" step="0.01"
                           onchange="actualizarCosto(${index}, this.value)">
                </td>
                <td class="text-success fw-bold">C$${item.costo_total.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    btnGuardar.disabled = !validarCamposRequeridos() || productosEntrada.length === 0;
    totalProductos.textContent = productosEntrada.length;
    totalCantidad.textContent = totalUnidades;
    totalMovimiento.textContent = `C$${totalGeneral.toFixed(2)}`;
    contador.textContent = productosEntrada.length;
}

function actualizarCantidad(index, nuevaCantidad) {
    const cantidad = parseInt(nuevaCantidad);
    if (cantidad > 0) {
        productosEntrada[index].cantidad = cantidad;
        productosEntrada[index].costo_total = cantidad * productosEntrada[index].costo;
        actualizarListaProductos();
    }
}

function actualizarCosto(index, nuevoCosto) {
    const costo = parseFloat(nuevoCosto);
    if (costo > 0) {
        productosEntrada[index].costo = costo;
        productosEntrada[index].costo_total = productosEntrada[index].cantidad * costo;
        actualizarListaProductos();
    }
}

function eliminarProducto(index) {
    if (confirm('¿Eliminar este producto de la entrada?')) {
        productosEntrada.splice(index, 1);
        actualizarListaProductos();
        mostrarToast('Producto eliminado', 'warning');
    }
}

function limpiarFormulario() {
    if (productosEntrada.length > 0 && !confirm('¿Estás seguro de limpiar todo el formulario? Se perderán todos los productos agregados.')) {
        return;
    }
    
    productosEntrada = [];
    actualizarListaProductos();
    document.getElementById('formEntrada').reset();
    document.getElementById('fecha_movimiento').value = new Date().toISOString().split('T')[0];
    document.getElementById('searchProducto').value = '';
    
    // Restablecer búsqueda de productos
    const rows = document.querySelectorAll('.producto-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    mostrarToast('Formulario limpiado', 'info');
}

async function guardarEntrada() {
    // Validaciones básicas
    if (!validarCamposRequeridos()) {
        mostrarToast('Completa todos los campos requeridos (*)', 'warning');
        return;
    }
    
    if (productosEntrada.length === 0) {
        mostrarToast('Agrega al menos un producto a la entrada', 'warning');
        return;
    }
    
    const btnGuardar = document.getElementById('btnGuardar');
    const originalText = btnGuardar.innerHTML;
    
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
    
    try {
        const response = await fetch('/inventario/entrada', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tipo_movimiento_id: document.getElementById('tipo_movimiento').value,
                proveedor_id: document.getElementById('proveedor').value,
                bodega_id: document.getElementById('bodega').value,
                n_factura: document.getElementById('n_factura').value,
                observacion: document.getElementById('observacion').value,
                items: productosEntrada.map(item => ({
                    producto_id: item.producto_id,
                    cantidad: item.cantidad,
                    costo: item.costo,
                    costo_total: item.costo_total
                }))
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast(data.message || '¡Entrada de inventario registrada exitosamente!', 'success');
            
            // Crear mensaje detallado
            let mensajeDetalle = `Movimiento #${data.movimiento_id} registrado.`;
            if (data.tipo_factura === 'factura_proveedor') {
                mensajeDetalle += ` Factura: ${data.n_factura}`;
            } else {
                mensajeDetalle += ` Referencia: ${data.n_factura}`;
            }
            mensajeDetalle += ` - ${data.total_productos} unidades - Total: C$${data.total_costo}`;
            
            // Limpiar el formulario para nueva entrada
            setTimeout(() => {
                productosEntrada = [];
                actualizarListaProductos();
                document.getElementById('formEntrada').reset();
                document.getElementById('fecha_movimiento').value = new Date().toISOString().split('T')[0];
                document.getElementById('searchProducto').value = '';
                
                // Restablecer búsqueda de productos
                const rows = document.querySelectorAll('.producto-row');
                rows.forEach(row => {
                    row.style.display = '';
                });
                
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
                
                // Mostrar mensaje detallado
                mostrarToast(mensajeDetalle, 'success');
                
            }, 1500);
            
        } else {
            throw new Error(data.message || 'Error al guardar la entrada');
        }
    } catch (error) {
        mostrarToast(error.message || 'Error de conexión', 'danger');
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = originalText;
    }
}

// Sistema de notificaciones Toast
function mostrarToast(mensaje, tipo = 'info') {
    // Crear o obtener el contenedor de toasts
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const icon = tipo === 'success' ? 'bi-check-circle' :
                 tipo === 'warning' ? 'bi-exclamation-triangle' :
                 tipo === 'danger' ? 'bi-x-circle' : 'bi-info-circle';
    
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${tipo} text-white">
                <i class="bi ${icon} me-2"></i>
                <strong class="me-auto">Sistema</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${mensaje}
            </div>
        </div>
    `;
    
    toastContainer.innerHTML += toastHtml;
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remover el toast después de que se oculte
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}
</script>
{% endblock %}