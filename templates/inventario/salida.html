{% extends "base.html" %}

{% block title %}Salida de Inventario - Licoreria G&G{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-box-arrow-up"></i> Salida de Inventario
        </h1>
        <div>
            <button class="btn btn-outline-secondary" onclick="limpiarFormulario()">
                <i class="bi bi-arrow-clockwise"></i> Limpiar
            </button>
            <a href="{{ url_for('inventario') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Panel de Control -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders"></i> Control de Salida</h5>
                </div>
                <div class="card-body">
                    <form id="formSalida">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Movimiento *</label>
                            <select id="tipo_movimiento" class="form-select" required>
                                <option value="">Seleccionar...</option>
                                {% for tipo in tipos_movimiento %}
                                <option value="{{ tipo.ID_TipoMovimiento }}">{{ tipo.Descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Bodega *</label>
                            <select id="bodega" class="form-select" required>
                                <option value="">Seleccionar...</option>
                                {% for bodega in bodegas %}
                                <option value="{{ bodega.ID_Bodega }}">{{ bodega.Nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Proveedor *</label>
                            <div class="d-flex gap-2">
                                <select id="id_proveedor" class="form-select" onchange="filtrarPorProveedor(this.value)">
                                    <option value="">Seleccionar (opcional)...</option>
                                    {% for proveedor in proveedores %}
                                    <option value="{{ proveedor.ID_Proveedor }}"
                                            {% if proveedor_filtro == proveedor.ID_Proveedor %}selected{% endif %}>
                                        {{ proveedor.Nombre }}
                                        {% if proveedor.RUC_CEDULA %}({{ proveedor.RUC_CEDULA }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if proveedor_filtro %}
                                <button type="button" class="btn btn-outline-danger" onclick="limpiarFiltroProveedor()">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% if proveedor_filtro %}
                            <small class="text-muted mt-1 d-block">
                                <i class="bi bi-info-circle"></i> Mostrando productos vendidos anteriormente a este cliente
                            </small>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">N° Factura/Comprobante</label>
                            <input type="text" id="n_factura" class="form-control" placeholder="Opcional">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Observación *</label>
                            <textarea id="observacion" class="form-control" rows="3" required 
                                      placeholder="Motivo de la salida..."></textarea>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Resumen -->
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Resumen</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Productos:</span>
                        <strong id="contadorProductos">0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Unidades:</span>
                        <strong id="totalUnidades">0</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Costo Estimado:</span>
                        <strong>C$<span id="totalCosto">0.00</span></strong>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button id="btnGuardar" class="btn btn-warning btn-lg" onclick="guardarSalida()" disabled>
                            <i class="bi bi-check-circle"></i> Registrar Salida
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Productos -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Productos Disponibles</h5>
                        {% if proveedor_filtro %}
                        <small class="d-block mt-1">
                            <i class="bi bi-lightning"></i> Filtro activo: {{ productos|length }} productos disponibles
                        </small>
                        {% endif %}
                    </div>
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchProducto" class="form-control" placeholder="Buscar producto...">
                    </div>
                </div>
                <div class="card-body">
                    <!-- Productos Agregados -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">
                            <i class="bi bi-list-check"></i> Productos a Retirar
                            <span class="badge bg-warning ms-2" id="contadorProductos2">0</span>
                        </h6>
                        <div id="productosAgregados" class="table-responsive" style="max-height: 200px;">
                            <table class="table table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Producto</th>
                                        <th width="100">Cantidad</th>
                                        <th width="100">Costo</th>
                                        <th width="80"></th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductosBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                            No hay productos agregados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Catálogo de Productos -->
                    <h6 class="border-bottom pb-2">
                        <i class="bi bi-box"></i> Catálogo de Productos
                        <span class="badge bg-light text-dark">{{ productos|length }}</span>
                    </h6>
                    
                    {% if proveedor_filtro and productos|length == 0 %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        No se encontraron productos vendidos anteriormente a este cliente.
                        <a href="#" onclick="limpiarFiltroProveedor()" class="alert-link">Ver todos los productos</a>
                    </div>
                    {% endif %}
                    
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Stock</th>
                                    <th>Costo</th>
                                    <th width="100"></th>
                                </tr>
                            </thead>
                            <tbody id="productosTableBody">
                                {% for producto in productos %}
                                <tr class="producto-row" data-nombre="{{ producto.Descripcion|lower }}">
                                    <td>
                                        <strong>{{ producto.Descripcion }}</strong>
                                        <br>
                                        <small class="text-muted">{{ producto.Abreviatura }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ producto.Categoria or 'Sin cat.' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge {% if producto.Stock_Total <= producto.Stock_Minimo %}bg-danger{% else %}bg-success{% endif %}">
                                            {{ "%.2f"|format(producto.Stock_Total) }}
                                        </span>
                                    </td>
                                    <td>C${{ "%.2f"|format(producto.Costo_Promedio or 0) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning" 
                                                onclick="agregarProductoSalida({{ producto.ID_Producto }}, '{{ producto.Descripcion }}', {{ producto.Stock_Total }}, '{{ producto.Abreviatura }}', {{ producto.Costo_Promedio or 0 }})">
                                            <i class="bi bi-dash-circle"></i> Retirar
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="bi bi-database-slash display-6 d-block mb-2"></i>
                                        No hay productos con stock disponible
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cantidad -->
<div class="modal fade" id="modalCantidad" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Especificar Cantidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="mb-1"><strong id="modalProductoNombre"></strong></p>
                    <p class="small text-muted mb-2">Stock: <span id="modalStockDisponible"></span> <span id="modalUnidad"></span></p>
                    
                    <label class="form-label">Cantidad a Retirar *</label>
                    <input type="number" id="modalCantidadInput" class="form-control" 
                           min="0.01" step="0.01" required>
                </div>
                <div class="text-center">
                    <p class="mb-0">Costo estimado:</p>
                    <h4 class="text-success" id="modalCostoTotal">C$0.00</h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="confirmarCantidad()">
                    <i class="bi bi-plus-circle"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let productosSalida = [];
let productoActual = null;
let modalCantidad = null;

document.addEventListener('DOMContentLoaded', function() {
    modalCantidad = new bootstrap.Modal(document.getElementById('modalCantidad'));
    
    // Búsqueda
    document.getElementById('searchProducto').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.producto-row');
        
        rows.forEach(row => {
            const nombre = row.getAttribute('data-nombre');
            row.style.display = nombre.includes(searchTerm) ? '' : 'none';
        });
    });
    
    // Calcular costo en tiempo real
    document.getElementById('modalCantidadInput').addEventListener('input', function() {
        calcularCostoModal();
    });
});

// FUNCIONES PARA FILTRO POR PROVEEDOR
function filtrarPorProveedor(proveedorId) {
    if (!proveedorId) return;
    const url = new URL(window.location.href);
    url.searchParams.set('proveedor_filtro', proveedorId);
    window.location.href = url.toString();
}

function limpiarFiltroProveedor() {
    const url = new URL(window.location.href);
    url.searchParams.delete('proveedor_filtro');
    window.location.href = url.toString();
}

function agregarProductoSalida(id, nombre, stock, unidad, costo) {
    productoActual = {
        producto_id: parseInt(id),
        nombre: nombre,
        stock_disponible: stock,
        unidad: unidad,
        costo_unitario: costo
    };
    
    // Configurar modal
    document.getElementById('modalProductoNombre').textContent = nombre;
    document.getElementById('modalStockDisponible').textContent = stock.toFixed(2);
    document.getElementById('modalUnidad').textContent = unidad;
    document.getElementById('modalCantidadInput').value = '';
    document.getElementById('modalCantidadInput').max = stock;
    document.getElementById('modalCostoTotal').textContent = 'C$0.00';
    
    modalCantidad.show();
}

function calcularCostoModal() {
    const cantidad = parseFloat(document.getElementById('modalCantidadInput').value) || 0;
    const costo = productoActual.costo_unitario || 0;
    document.getElementById('modalCostoTotal').textContent = `C$${(cantidad * costo).toFixed(2)}`;
}

function confirmarCantidad() {
    const cantidad = parseFloat(document.getElementById('modalCantidadInput').value) || 0;
    
    if (!cantidad || cantidad <= 0) {
        mostrarToast('Ingrese una cantidad válida', 'warning');
        return;
    }
    
    if (cantidad > productoActual.stock_disponible) {
        mostrarToast(`Cantidad excede el stock disponible (${productoActual.stock_disponible})`, 'danger');
        return;
    }
    
    const costoTotal = cantidad * productoActual.costo_unitario;
    
    // Verificar si ya existe
    const index = productosSalida.findIndex(p => p.producto_id === productoActual.producto_id);
    
    if (index !== -1) {
        productosSalida[index].cantidad = cantidad;
        productosSalida[index].costo_total = costoTotal;
        mostrarToast('Producto actualizado', 'info');
    } else {
        productosSalida.push({
            producto_id: productoActual.producto_id,
            nombre: productoActual.nombre,
            cantidad: cantidad,
            costo_unitario: productoActual.costo_unitario,
            costo_total: costoTotal,
            unidad: productoActual.unidad
        });
        mostrarToast('Producto agregado', 'success');
    }
    
    modalCantidad.hide();
    actualizarListaProductos();
}

function actualizarListaProductos() {
    const tbody = document.getElementById('tablaProductosBody');
    const contador = document.getElementById('contadorProductos');
    const contador2 = document.getElementById('contadorProductos2');
    const btnGuardar = document.getElementById('btnGuardar');
    const totalUnidades = document.getElementById('totalUnidades');
    const totalCosto = document.getElementById('totalCosto');
    
    if (productosSalida.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-6 d-block mb-2"></i>
                    No hay productos agregados
                </td>
            </tr>
        `;
        btnGuardar.disabled = true;
        contador.textContent = '0';
        contador2.textContent = '0';
        totalUnidades.textContent = '0';
        totalCosto.textContent = '0.00';
        return;
    }
    
    let html = '';
    let totalUnidadesSum = 0;
    let totalCostoSum = 0;
    
    productosSalida.forEach((item, index) => {
        totalUnidadesSum += item.cantidad;
        totalCostoSum += item.costo_total;
        
        html += `
            <tr>
                <td>
                    <strong>${item.nombre}</strong>
                    <br><small class="text-muted">${item.unidad}</small>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${item.cantidad}" min="0.01" step="0.01"
                           onchange="actualizarCantidadSalida(${index}, this.value)">
                </td>
                <td>C$${item.costo_total.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarProductoSalida(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    btnGuardar.disabled = false;
    contador.textContent = productosSalida.length;
    contador2.textContent = productosSalida.length;
    totalUnidades.textContent = totalUnidadesSum.toFixed(2);
    totalCosto.textContent = totalCostoSum.toFixed(2);
}

function actualizarCantidadSalida(index, nuevaCantidad) {
    const cantidad = parseFloat(nuevaCantidad);
    if (cantidad > 0 && cantidad <= productosSalida[index].stock_disponible) {
        productosSalida[index].cantidad = cantidad;
        productosSalida[index].costo_total = cantidad * productosSalida[index].costo_unitario;
        actualizarListaProductos();
    }
}

function eliminarProductoSalida(index) {
    if (confirm('¿Eliminar este producto de la salida?')) {
        productosSalida.splice(index, 1);
        actualizarListaProductos();
        mostrarToast('Producto eliminado', 'warning');
    }
}

function limpiarFormulario() {
    if (productosSalida.length > 0 && !confirm('¿Limpiar todo el formulario?')) {
        return;
    }
    
    productosSalida = [];
    actualizarListaProductos();
    document.getElementById('formSalida').reset();
    document.getElementById('searchProducto').value = '';
    
    // Restablecer búsqueda
    const rows = document.querySelectorAll('.producto-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    mostrarToast('Formulario limpiado', 'info');
}

async function guardarSalida() {
    const tipoMovimiento = document.getElementById('tipo_movimiento').value;
    const bodega = document.getElementById('bodega').value;
    const observacion = document.getElementById('observacion').value;
    
    if (!tipoMovimiento || !bodega || !observacion) {
        mostrarToast('Complete todos los campos requeridos', 'warning');
        return;
    }
    
    if (productosSalida.length === 0) {
        mostrarToast('Agregue al menos un producto', 'warning');
        return;
    }
    
    const btnGuardar = document.getElementById('btnGuardar');
    const originalText = btnGuardar.innerHTML;
    
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
    
    try {
        const response = await fetch('/inventario/salida', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tipo_movimiento_id: tipoMovimiento,
                bodega_id: bodega,
                observacion: observacion,
                n_factura: document.getElementById('n_factura').value,
                id_proveedor: document.getElementById('id_proveedor').value || null,
                items: productosSalida.map(p => ({
                    producto_id: p.producto_id,
                    cantidad: p.cantidad
                }))
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast('✅ Salida registrada exitosamente', 'success');
            
            // Limpiar después de 1 segundo
            setTimeout(() => {
                limpiarFormulario();
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
            }, 1000);
        } else {
            throw new Error(data.message || 'Error al guardar');
        }
    } catch (error) {
        mostrarToast(error.message, 'danger');
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = originalText;
    }
}

// Sistema de notificaciones Toast
function mostrarToast(mensaje, tipo = 'info') {
    const toastContainer = document.getElementById('toastContainer') || crearToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-bg-${tipo} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.innerHTML += toastHtml;
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function crearToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}