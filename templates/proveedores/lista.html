{% extends "base.html" %}

{% block title %}Proveedores - Licoreria G&G{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-truck"></i> Gestión de Proveedores</h1>
        <a href="{{ url_for('proveedor_nuevo') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nuevo Proveedor
        </a>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="mb-3">
                <input type="text" id="searchInput" class="form-control" 
                       placeholder="Buscar proveedores..." onkeyup="buscarEnTabla('searchInput', 'proveedoresTable')">
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="proveedoresTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>RUC/Cédula</th>
                            <th>Teléfono</th>
                            <th>Dirección</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proveedor in proveedores %}
                        <tr>
                            <td>{{ proveedor.ID_Proveedor }}</td>
                            <td>{{ proveedor.Nombre }}</td>
                            <td>{{ proveedor.RUC_CEDULA or '-' }}</td>
                            <td>
                                {% if proveedor.Telefono %}
                                <a href="tel:{{ proveedor.Telefono }}" class="text-decoration-none">
                                    <i class="bi bi-telephone"></i> {{ proveedor.Telefono }}
                                </a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ proveedor.Direccion or '-' }}</td>
                            <td>
                                <span class="badge badge-{% if proveedor.Estado == 'activo' %}success{% else %}secondary{% endif %}">
                                    {{ proveedor.Estado|title }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('proveedor_editar', id=proveedor.ID_Proveedor) }}" 
                                       class="btn btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-outline-danger btn-eliminar-proveedor"
                                            data-id="{{ proveedor.ID_Proveedor }}"
                                            data-nombre="{{ proveedor.Nombre }}"
                                            data-ruc="{{ proveedor.RUC_CEDULA or 'Sin RUC/Cédula' }}"
                                            data-estado="{{ proveedor.Estado }}"
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No hay proveedores registrados</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar Proveedor -->
<div class="modal fade" id="modalEliminarProveedor" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <span id="modalTitulo">Eliminar Proveedor</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="bi bi-truck text-danger" style="font-size: 3rem;"></i>
                </div>
                <h5 class="mb-3" id="modalMensaje">¿Está seguro de eliminar este proveedor?</h5>
                
                <div class="alert alert-light border mb-3">
                    <p class="mb-1 fw-bold" id="modalProveedorNombre"></p>
                    <p class="mb-0">RUC/Cédula: <span id="modalProveedorRuc"></span></p>
                    <p class="mb-0">Estado actual: <span id="modalProveedorEstado" class="badge"></span></p>
                </div>
                
                <div class="alert alert-warning" id="alertaCompras" style="display: none;">
                    <small>
                        <i class="bi bi-info-circle"></i> 
                        Este proveedor tiene compras asociadas. En lugar de eliminarse completamente, 
                        se cambiará a estado <strong>inactivo</strong>.
                    </small>
                </div>
                
                <div class="alert alert-danger" id="alertaEliminacion">
                    <small>
                        <i class="bi bi-exclamation-triangle"></i> 
                        <span id="textoAccion">Esta acción no se puede deshacer</span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <form method="POST" id="formEliminarProveedor">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> <span id="textoBoton">Sí, Eliminar</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Función para buscar en tabla
function buscarEnTabla(inputId, tableId) {
    const input = document.getElementById(inputId);
    const filter = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let mostrar = false;
        
        for (let j = 0; j < td.length; j++) {
            if (td[j]) {
                if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                    mostrar = true;
                    break;
                }
            }
        }
        
        tr[i].style.display = mostrar ? '' : 'none';
    }
}

// Configuración para el modal de eliminar proveedor
document.addEventListener('click', function(e) {
    // Si se hace clic en un botón de eliminar
    if (e.target.closest('.btn-eliminar-proveedor')) {
        e.preventDefault();
        const boton = e.target.closest('.btn-eliminar-proveedor');
        
        // Obtener datos del proveedor
        const proveedorId = boton.getAttribute('data-id');
        const proveedorNombre = boton.getAttribute('data-nombre');
        const proveedorRuc = boton.getAttribute('data-ruc');
        const proveedorEstado = boton.getAttribute('data-estado');
        
        // Mostrar información en el modal
        document.getElementById('modalProveedorNombre').textContent = proveedorNombre;
        document.getElementById('modalProveedorRuc').textContent = proveedorRuc;
        
        // Mostrar estado actual
        const estadoSpan = document.getElementById('modalProveedorEstado');
        estadoSpan.textContent = proveedorEstado.charAt(0).toUpperCase() + proveedorEstado.slice(1);
        estadoSpan.className = 'badge ' + (proveedorEstado === 'activo' ? 'badge-success' : 'badge-secondary');
        
        // Configurar alerta para proveedores activos
        if (proveedorEstado === 'activo') {
            document.getElementById('alertaCompras').style.display = 'block';
            document.getElementById('textoAccion').textContent = 'Si el proveedor tiene compras asociadas, se cambiará a inactivo.';
        } else {
            document.getElementById('alertaCompras').style.display = 'none';
            document.getElementById('textoAccion').textContent = 'Esta acción no se puede deshacer';
        }
        
        // Configurar el formulario con la URL correcta
        const formEliminar = document.getElementById('formEliminarProveedor');
        formEliminar.action = `/proveedores/eliminar/${proveedorId}`;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalEliminarProveedor'));
        modal.show();
    }
});
</script>

<style>
/* Estilo simple para el enlace de teléfono */
a.text-decoration-none {
    color: #0d6efd;
    transition: color 0.2s;
}

a.text-decoration-none:hover {
    color: #0a58ca;
    text-decoration: underline;
}

/* Estilos básicos para el modal */
.modal-content {
    border-radius: 10px;
    border: none;
}

.btn-danger {
    padding: 8px 20px;
}

.btn-secondary {
    padding: 8px 20px;
}

/* Estilos para badges de estado */
.badge-success {
    background-color: #198754;
    color: white;
}

.badge-secondary {
    background-color: #6c757d;
    color: white;
}

.badge {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 700;
    border-radius: 0.375rem;
}
</style>
{% endblock %}