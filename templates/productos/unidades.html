{% extends "base.html" %}

{% block title %}Unidades de Medida - Licoreria G&G{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-rulers"></i> Unidades de Medida</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaUnidad">
            <i class="bi bi-plus-circle"></i> Nueva Unidad
        </button>
    </div>

    <!-- Mensajes flash en posición fija -->
    <div id="flash-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show shadow-lg mb-3 flash-alert">
                    <div class="d-flex align-items-center">
                        <i class="bi {% if category == 'error' %}bi-exclamation-triangle-fill{% else %}bi-check-circle-fill{% endif %} me-2 fs-5"></i>
                        <div class="flex-grow-1">{{ message }}</div>
                        <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Descripción</th>
                                    <th>Abreviatura</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for unidad in unidades %}
                                <tr>
                                    <td>{{ unidad.ID_Unidad }}</td>
                                    <td>{{ unidad.Descripcion }}</td>
                                    <td><span class="badge bg-secondary">{{ unidad.Abreviatura }}</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-editar-unidad"
                                                    data-id="{{ unidad.ID_Unidad }}"
                                                    data-descripcion="{{ unidad.Descripcion }}"
                                                    data-abreviatura="{{ unidad.Abreviatura }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-eliminar-unidad"
                                                    data-id="{{ unidad.ID_Unidad }}"
                                                    data-descripcion="{{ unidad.Descripcion }}"
                                                    data-abreviatura="{{ unidad.Abreviatura }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No hay unidades registradas</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Unidad -->
<div class="modal fade" id="modalNuevaUnidad" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('unidad_nueva') }}">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Nueva Unidad de Medida
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">
                            <i class="bi bi-card-text"></i> Descripción
                        </label>
                        <input type="text" class="form-control" id="descripcion" name="descripcion" 
                               required maxlength="50" placeholder="Ej: Kilogramo, Litro, Unidad">
                    </div>
                    <div class="mb-3">
                        <label for="abreviatura" class="form-label">
                            <i class="bi bi-type"></i> Abreviatura
                        </label>
                        <input type="text" class="form-control" id="abreviatura" name="abreviatura" 
                               maxlength="10" required placeholder="Ej: kg, L, und">
                        <div class="form-text">Máximo 10 caracteres</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Unidad -->
<div class="modal fade" id="modalEditarUnidad" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="formEditarUnidad">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square"></i> Editar Unidad de Medida
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="descripcion_edit" class="form-label">
                            <i class="bi bi-card-text"></i> Descripción
                        </label>
                        <input type="text" class="form-control" id="descripcion_edit" name="descripcion" 
                               required maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label for="abreviatura_edit" class="form-label">
                            <i class="bi bi-type"></i> Abreviatura
                        </label>
                        <input type="text" class="form-control" id="abreviatura_edit" name="abreviatura" 
                               maxlength="10" required>
                        <div class="form-text">Máximo 10 caracteres</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning text-white">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar Unidad -->
<div class="modal fade" id="modalEliminarUnidad" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i> Eliminar Unidad de Medida
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <i class="bi bi-rulers text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="fw-bold">¿Eliminar esta unidad?</h4>
                </div>
                
                <div class="card border-danger mb-3">
                    <div class="card-body text-center">
                        <h5 class="card-title text-danger" id="modalUnidadDescripcion"></h5>
                        <div class="d-flex justify-content-center gap-3 mt-2">
                            <span class="badge bg-secondary" id="modalUnidadAbreviatura"></span>
                            <span class="badge bg-dark" id="modalUnidadId"></span>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-danger">
                    <div class="d-flex">
                        <i class="bi bi-exclamation-octagon-fill me-2 flex-shrink-0"></i>
                        <div>
                            <strong>¡Precaución!</strong>
                            <p class="mb-0 mt-1 small">
                                Esta unidad podría estar siendo utilizada por productos existentes.
                                Su eliminación podría afectar la consistencia de los datos.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle"></i>
                    <small>Esta acción no se puede deshacer.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <form method="POST" id="formEliminarUnidad">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash-fill"></i> Sí, Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Éxito -->
<div class="modal fade" id="modalExito" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <div class="rounded-circle bg-success d-inline-flex align-items-center justify-content-center" 
                         style="width: 70px; height: 70px;">
                        <i class="bi bi-check-lg text-white" style="font-size: 2rem;"></i>
                    </div>
                </div>
                <h5 class="text-success mb-2" id="tituloExito">¡Completado!</h5>
                <p class="text-muted mb-0 small" id="mensajeExito"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center pt-0">
                <button type="button" class="btn btn-success btn-sm px-3" data-bs-dismiss="modal">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Event delegation para editar unidad
document.addEventListener('click', function(e) {
    // Botón editar
    if (e.target.closest('.btn-editar-unidad')) {
        e.preventDefault();
        const boton = e.target.closest('.btn-editar-unidad');
        
        const id = boton.getAttribute('data-id');
        const descripcion = boton.getAttribute('data-descripcion');
        const abreviatura = boton.getAttribute('data-abreviatura');
        
        document.getElementById('descripcion_edit').value = descripcion;
        document.getElementById('abreviatura_edit').value = abreviatura;
        document.getElementById('formEditarUnidad').action = `/unidades-medida/editar/${id}`;
        
        const modal = new bootstrap.Modal(document.getElementById('modalEditarUnidad'));
        modal.show();
    }
    
    // Botón eliminar
    if (e.target.closest('.btn-eliminar-unidad')) {
        e.preventDefault();
        const boton = e.target.closest('.btn-eliminar-unidad');
        
        const id = boton.getAttribute('data-id');
        const descripcion = boton.getAttribute('data-descripcion');
        const abreviatura = boton.getAttribute('data-abreviatura');
        
        // Mostrar información en el modal de eliminación
        document.getElementById('modalUnidadDescripcion').textContent = descripcion;
        document.getElementById('modalUnidadAbreviatura').textContent = abreviatura;
        document.getElementById('modalUnidadId').textContent = 'ID: ' + id;
        
        // Configurar formulario de eliminación
        const formEliminar = document.getElementById('formEliminarUnidad');
        formEliminar.action = `/unidades-medida/eliminar/${id}`;
        
        // Mostrar modal de eliminación
        const modal = new bootstrap.Modal(document.getElementById('modalEliminarUnidad'));
        modal.show();
    }
});

// Configurar envío del formulario de eliminación
const formEliminar = document.getElementById('formEliminarUnidad');
if (formEliminar) {
    formEliminar.addEventListener('submit', function(e) {
        // Cambiar texto del botón mientras se procesa
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHtml = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';
        submitBtn.disabled = true;
        
        // Cerrar modal de confirmación
        const modalConfirmar = bootstrap.Modal.getInstance(document.getElementById('modalEliminarUnidad'));
        if (modalConfirmar) {
            modalConfirmar.hide();
        }
    });
}

// Configurar formulario de edición
const formEditar = document.getElementById('formEditarUnidad');
if (formEditar) {
    formEditar.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHtml = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';
        submitBtn.disabled = true;
    });
}

// Configurar formulario de nueva unidad
const formNueva = document.querySelector('#modalNuevaUnidad form');
if (formNueva) {
    formNueva.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHtml = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
        submitBtn.disabled = true;
    });
}

// Mostrar mensajes flash en modal de éxito si existen
document.addEventListener('DOMContentLoaded', function() {
    // Mover mensajes flash al contenedor fijo
    const flashMessages = document.querySelectorAll('.alert:not(.flash-alert)');
    const flashContainer = document.getElementById('flash-container');
    
    if (flashMessages.length > 0 && flashContainer) {
        flashMessages.forEach(msg => {
            if (!msg.closest('#flash-container')) {
                msg.classList.add('flash-alert');
                flashContainer.appendChild(msg);
            }
        });
    }
    
    // Mostrar modal de éxito si hay mensaje flash
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == 'success' %}
                    document.getElementById('mensajeExito').textContent = "{{ message }}";
                    const modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                    setTimeout(() => {
                        modalExito.show();
                    }, 300);
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    // Auto-cierre de mensajes flash después de 5 segundos
    setTimeout(() => {
        document.querySelectorAll('.flash-alert').forEach(alert => {
            const bsAlert = bootstrap.Alert.getInstance(alert) || new bootstrap.Alert(alert);
            setTimeout(() => bsAlert.close(), 5000);
        });
    }, 5000);
});

// Override CSS para asegurar que los mensajes sean visibles
const style = document.createElement('style');
style.textContent = `
    .flash-alert {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        z-index: 99999 !important;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
    }
    
    body.modal-open {
        overflow: visible !important;
        padding-right: 0 !important;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .btn-eliminar-unidad:hover {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-editar-unidad:hover {
        background-color: #0d6efd;
        color: white;
    }
    
    .modal-content {
        border-radius: 10px;
        border: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}