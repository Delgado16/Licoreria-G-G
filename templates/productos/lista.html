{% extends "base.html" %}

{% block title %}Productos - Licoreria G&G{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-box-seam"></i> Gestión de Productos</h1>
        <a href="{{ url_for('producto_nuevo') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nuevo Producto
        </a>
    </div>

    <!-- LOS MENSAJES DEBEN ESTAR FUERA DEL CONTENEDOR PRINCIPAL DE MODALES -->
    <!-- Los ponemos en una posición fija para que siempre sean visibles -->
    <div id="flash-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show shadow-lg mb-3 flash-alert">
                    <div class="d-flex align-items-center">
                        <i class="bi {% if category == 'error' %}bi-exclamation-triangle-fill{% else %}bi-check-circle-fill{% endif %} me-2 fs-5"></i>
                        <div class="flex-grow-1">{{ message }}</div>
                        <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="card shadow mt-4">
        <div class="card-body">
            <div class="mb-3">
                <input type="text" id="searchInput" class="form-control" 
                       placeholder="Buscar productos..." onkeyup="buscarEnTabla('searchInput', 'productosTable')">
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="productosTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Descripción</th>
                            <th>Categoría</th>
                            <th>Unidad</th>
                            <th>Existencias</th>
                            <th>Stock Mínimo</th>
                            <th>Costo</th>
                            <th>Precio Venta</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                        <tr>
                            <td>{{ producto.ID_Producto }}</td>
                            <td>{{ producto.Descripcion }}</td>
                            <td>{{ producto.Categoria or 'Sin categoría' }}</td>
                            <td>{{ producto.Abreviatura }}</td>
                            <td>
                                <span class="badge {% if producto.Existencias_Totales <= producto.Stock_Minimo %}bg-warning{% else %}bg-success{% endif %}">
                                    {{ producto.Existencias_Totales|int }}
                                </span>
                            </td>
                            <td>{{ producto.Stock_Minimo|int }}</td>
                            <td>C${{ "%.2f"|format(producto.Costo_Promedio or 0) }}</td>
                            <td>C${{ "%.2f"|format(producto.Precio_Venta or 0) }}</td>
                            <td>
                                <span class="badge {% if producto.Existencias_Totales <= producto.Stock_Minimo %}bg-warning{% else %}bg-success{% endif %}">
                                    {{ 'Stock Bajo' if producto.Existencias_Totales <= producto.Stock_Minimo else 'Normal' }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('producto_editar', id=producto.ID_Producto) }}" 
                                       class="btn btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-outline-danger btn-eliminar"
                                            data-id="{{ producto.ID_Producto }}"
                                            data-nombre="{{ producto.Descripcion }}"
                                            data-stock="{{ producto.Existencias_Totales }}"
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted">No hay productos registrados</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación - CON backdrop static -->
<div class="modal fade" id="modalConfirmar" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-trash3 text-danger" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">¿Eliminar Producto?</h4>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title text-primary" id="modalNombreProducto"></h6>
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Stock Actual:</small>
                                <div class="fw-bold" id="modalStockProducto"></div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ID:</small>
                                <div class="fw-bold" id="modalIdProducto"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <form method="POST" id="formEliminar">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash-fill"></i> Sí, Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Función para buscar en tabla
function buscarEnTabla(inputId, tableId) {
    const input = document.getElementById(inputId);
    const filter = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let mostrar = false;
        
        for (let j = 0; j < td.length; j++) {
            if (td[j]) {
                if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                    mostrar = true;
                    break;
                }
            }
        }
        
        tr[i].style.display = mostrar ? '' : 'none';
    }
}

// SOLUCIÓN DEFINITIVA: Usar event delegation y posicionamiento fijo para mensajes
document.addEventListener('DOMContentLoaded', function() {
    // 1. Mover los mensajes flash a una posición fija si no están ya allí
    const flashMessages = document.querySelectorAll('.alert:not(.flash-alert)');
    const flashContainer = document.getElementById('flash-container');
    
    if (flashMessages.length > 0 && flashContainer) {
        flashMessages.forEach(msg => {
            if (!msg.closest('#flash-container')) {
                msg.classList.add('flash-alert');
                flashContainer.appendChild(msg);
            }
        });
    }
    
    // 2. Configurar auto-cierre de mensajes después de 5 segundos
    setTimeout(() => {
        document.querySelectorAll('.flash-alert').forEach(alert => {
            const bsAlert = new bootstrap.Alert(alert);
            setTimeout(() => bsAlert.close(), 5000);
        });
    }, 5000);
});

// Event delegation para botones de eliminar - ESTO FUNCIONA SIEMPRE
document.addEventListener('click', function(e) {
    // Verificar si se hizo clic en un botón de eliminar
    const eliminarBtn = e.target.closest('.btn-eliminar');
    
    if (eliminarBtn) {
        e.preventDefault();
        
        // Obtener datos del producto
        const productoId = eliminarBtn.getAttribute('data-id');
        const productoNombre = eliminarBtn.getAttribute('data-nombre');
        const productoStock = eliminarBtn.getAttribute('data-stock');
        
        // Mostrar información en el modal
        document.getElementById('modalNombreProducto').textContent = productoNombre;
        document.getElementById('modalStockProducto').textContent = parseInt(productoStock) + ' unidades';
        document.getElementById('modalIdProducto').textContent = '#' + productoId;
        
        // Configurar el formulario con la URL correcta
        const formEliminar = document.getElementById('formEliminar');
        formEliminar.action = `/productos/eliminar/${productoId}`;
        
        // OPCIONAL: Cerrar mensajes flash antes de abrir el modal
        document.querySelectorAll('.flash-alert').forEach(alert => {
            const bsAlert = bootstrap.Alert.getInstance(alert);
            if (bsAlert) bsAlert.close();
        });
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmar'));
        modal.show();
    }
});

// Manejar el envío del formulario
const formEliminar = document.getElementById('formEliminar');
if (formEliminar) {
    formEliminar.addEventListener('submit', function(e) {
        // Cambiar texto del botón mientras se procesa
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHtml = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';
        submitBtn.disabled = true;
        
        // El formulario se enviará normalmente, Flask redireccionará
        // No usamos e.preventDefault() para permitir el envío tradicional
    });
}

// SOLUCIÓN ALTERNATIVA: Si aún hay problemas, usar este override CSS
const style = document.createElement('style');
style.textContent = `
    /* Forzar que los mensajes flash estén SIEMPRE visibles */
    .flash-alert {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        z-index: 99999 !important; /* Valor MUY alto */
        max-width: 400px;
        animation: slideInRight 0.3s ease;
    }
    
    /* Cuando Bootstrap abre un modal, añade esta clase al body */
    body.modal-open {
        overflow: visible !important; /* Esto evita que se escondan elementos */
        padding-right: 0 !important; /* Elimina el padding que Bootstrap añade */
    }
    
    /* Asegurar que el modal esté debajo de los mensajes */
    .modal {
        z-index: 1055 !important; /* Bootstrap default */
    }
    
    .modal-backdrop {
        z-index: 1050 !important; /* Bootstrap default */
    }
    
    /* Animación para los mensajes */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Asegurar que los mensajes no desaparezcan con modales */
    .flash-alert .btn-close {
        position: relative;
        z-index: 100000;
    }
`;
document.head.appendChild(style);
</script>

<style>
/* Estilos básicos para mejor apariencia */
.modal-content {
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.btn-eliminar:hover {
    background-color: #dc3545;
    color: white;
    transform: scale(1.05);
    transition: all 0.2s;
}

#productosTable tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}
</style>
{% endblock %}